# TaréŸ³é¢‘Tokenæå–å·¥å…·

è¿™æ˜¯ä¸€ä¸ªç”¨äºä»taræ ¼å¼çš„éŸ³é¢‘æ•°æ®é›†ä¸­æå–éŸ³é¢‘tokençš„å·¥å…·ã€‚è¯¥å·¥å…·æ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°ä»å¤§é‡éŸ³é¢‘æ–‡ä»¶ä¸­æå–BiCodecéŸ³é¢‘tokenã€‚

> **æ³¨æ„**: è¿™æ˜¯ `utils/extract_tar_tokens.py` å·¥å…·çš„ä¸“ç”¨è¯´æ˜æ–‡æ¡£ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šGPUå¹¶è¡Œå¤„ç†ï¼Œæé«˜å¤„ç†æ•ˆç‡
- ğŸµ **éŸ³é¢‘æ ¼å¼æ”¯æŒ**: æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼çš„è‡ªåŠ¨è½¬æ¢å’Œé‡é‡‡æ ·
- ğŸ’¾ **å†…å­˜ä¼˜åŒ–**: å†…ç½®å†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶æœºåˆ¶
- ğŸ“Š **å®æ—¶ç›‘æ§**: æä¾›å¤„ç†è¿›åº¦å’Œæ€§èƒ½ç»Ÿè®¡ä¿¡æ¯
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰å¤„ç†å‚æ•°å’ŒGPUåˆ†é…ç­–ç•¥

## ç¯å¢ƒè¦æ±‚

- Python 3.7+
- PyTorch
- torchaudio
- soundfile
- datasets
- librosa
- psutil
- tqdm

## å®‰è£…ä¾èµ–

```bash
pip install torch torchaudio soundfile datasets librosa psutil tqdm
```

## æ¨¡å‹ä¸‹è½½

åœ¨ä½¿ç”¨å·¥å…·ä¹‹å‰ï¼Œéœ€è¦ä¸‹è½½Spark-TTSæ¨¡å‹ï¼š

### Spark-TTS-0.5Bæ¨¡å‹
- **ä¸‹è½½åœ°å€**: [Spark-TTS-0.5B](https://modelscope.cn/models/SparkAudio/Spark-TTS-0.5B)
- **æ¨¡å‹å¤§å°**: çº¦500MB
- **ä¸‹è½½æ–¹å¼**: ä»ModelScopeä¸‹è½½å¹¶è§£å‹åˆ°æŒ‡å®šç›®å½•

```bash
# ç¤ºä¾‹ï¼šä¸‹è½½å¹¶è®¾ç½®æ¨¡å‹ç›®å½•
mkdir -p /home/yueyulin/models/
# ä»ModelScopeä¸‹è½½Spark-TTS-0.5Bæ¨¡å‹åˆ° /home/yueyulin/models/Spark-TTS-0.5B/
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
python utils/extract_tar_tokens.py \
    --input_dir /path/to/tar/files \
    --output_dir /path/to/output \
    --model_dir /path/to/spark-tts/model
```

### å®Œæ•´å‚æ•°è¯´æ˜

```bash
python utils/extract_tar_tokens.py \
    --input_dir /tmp/tmp_data/ \
    --output_dir /home/yueyulin/data/Emilia/ZH/tar_tokens/ \
    --model_dir /home/yueyulin/models/Spark-TTS-0.5B/ \
    --num_proc 4 \
    --from_index 0 \
    --to_index 100
```

### å‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--input_dir` | str | `/tmp/tmp_data/` | è¾“å…¥taræ–‡ä»¶ç›®å½•è·¯å¾„ |
| `--output_dir` | str | `/home/yueyulin/data/Emilia/ZH/tar_tokens/` | è¾“å‡ºJSONLæ–‡ä»¶ç›®å½•è·¯å¾„ |
| `--model_dir` | str | `/home/yueyulin/models/Spark-TTS-0.5B/` | Spark-TTSæ¨¡å‹ç›®å½•è·¯å¾„ï¼Œæ¨¡å‹ä¸‹è½½åœ°å€ï¼š[Spark-TTS-0.5B](https://modelscope.cn/models/SparkAudio/Spark-TTS-0.5B) |
| `--num_proc` | int | 4 | å¹¶è¡Œå¤„ç†è¿›ç¨‹æ•°é‡ |
| `--from_index` | int | 0 | å¼€å§‹å¤„ç†çš„æ–‡ä»¶ç´¢å¼•ï¼ˆåŒ…å«ï¼‰ |
| `--to_index` | int | None | ç»“æŸå¤„ç†çš„æ–‡ä»¶ç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰ï¼ŒNoneè¡¨ç¤ºå¤„ç†æ‰€æœ‰æ–‡ä»¶ |

## è¾“å‡ºæ ¼å¼

å·¥å…·ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹ç”Ÿæˆä¸€ä¸ªJSONLæ–‡ä»¶ï¼Œæ–‡ä»¶åæ ¼å¼ä¸ºï¼š`{input_dir_name}_{process_id}.jsonl`

æ¯ä¸ªè¾“å‡ºè¡ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```json
{
    "language": "zh",
    "text": "éŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹",
    "global_tokens": [1, 2, 3, ...],
    "semantic_tokens": [1, 2, 3, ...]
}
```

## GPUåˆ†é…ç­–ç•¥

å·¥å…·ä¼šæ ¹æ®è¿›ç¨‹IDè‡ªåŠ¨åˆ†é…GPUèµ„æºï¼š
- æ¯ä¸ªGPUæœ€å¤šåˆ†é…2ä¸ªè¿›ç¨‹
- GPUåˆ†é…å…¬å¼ï¼š`gpu_id = (process_id // 2) % device_count`
- å¦‚æœæ²¡æœ‰å¯ç”¨GPUï¼Œå°†ä½¿ç”¨CPUå¤„ç†

### å¤§éŸ³é¢‘æ–‡ä»¶å¤„ç†

**é‡è¦æç¤º**: å¦‚æœå¤„ç†ç‰¹åˆ«å¤§çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆå¦‚é•¿éŸ³é¢‘ã€é«˜é‡‡æ ·ç‡éŸ³é¢‘ï¼‰ï¼Œè¯·ä¿®æ”¹GPUåˆ†é…ç­–ç•¥ï¼š

1. **ä¿®æ”¹GPUåˆ†é…å…¬å¼**: å°†æ¯ä¸ªGPUçš„è¿›ç¨‹æ•°é™åˆ¶ä¸º1ä¸ª
   ```python
   # åœ¨ä»£ç ä¸­ä¿®æ”¹ get_available_gpu å‡½æ•°
   gpu_id = process_id % device_count  # æ¯ä¸ªGPUåªåˆ†é…1ä¸ªè¿›ç¨‹
   ```

2. **è®¾ç½®è¿›ç¨‹æ•°**: å°† `--num_proc` å‚æ•°è®¾ç½®ä¸º1
   ```bash
   python utils/extract_tar_tokens.py \
       --input_dir /path/to/large/audio/files \
       --output_dir /path/to/output \
       --model_dir /path/to/spark-tts/model \
       --num_proc 1  # å¤§éŸ³é¢‘æ–‡ä»¶å»ºè®®ä½¿ç”¨å•è¿›ç¨‹
   ```

**åŸå› è¯´æ˜**:
- å¤§éŸ³é¢‘æ–‡ä»¶ä¼šå ç”¨æ›´å¤šGPUå†…å­˜
- å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†å¯èƒ½å¯¼è‡´GPUå†…å­˜ä¸è¶³
- å•è¿›ç¨‹å¤„ç†å¯ä»¥é¿å…å†…å­˜ç«äº‰å’ŒOOMé”™è¯¯

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- è‡ªåŠ¨æ¸…ç†GPUç¼“å­˜å’Œå†…å­˜
- æ¯å¤„ç†1000ä¸ªè¯·æ±‚è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
- å†…å­˜ä½¿ç”¨è¶…è¿‡100GBæ—¶è§¦å‘é¢å¤–æ¸…ç†

### å¤„ç†ç»Ÿè®¡
å·¥å…·ä¼šå®šæœŸè¾“å‡ºå¤„ç†ç»Ÿè®¡ä¿¡æ¯ï¼š
- æ€»è¯·æ±‚æ•°
- æ€»å¤„ç†æ—¶é—´
- å¹³å‡å¤„ç†æ—¶é—´

## é”™è¯¯å¤„ç†

- è‡ªåŠ¨å¤„ç†éŸ³é¢‘æ ¼å¼è½¬æ¢é”™è¯¯
- æ”¯æŒé‡‡æ ·ç‡è‡ªåŠ¨é‡é‡‡æ ·
- è¿›ç¨‹å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯
- æ”¯æŒé”®ç›˜ä¸­æ–­ä¼˜é›…é€€å‡º

## ä½¿ç”¨ç¤ºä¾‹

### å¤„ç†æŒ‡å®šèŒƒå›´çš„æ–‡ä»¶

```bash
# å¤„ç†ç¬¬10åˆ°ç¬¬50ä¸ªtaræ–‡ä»¶
python utils/extract_tar_tokens.py \
    --input_dir /data/audio_tars \
    --output_dir /output/tokens \
    --from_index 10 \
    --to_index 50 \
    --num_proc 8
```

### ä½¿ç”¨æ›´å¤šè¿›ç¨‹æé«˜å¤„ç†é€Ÿåº¦

```bash
# ä½¿ç”¨8ä¸ªè¿›ç¨‹å¹¶è¡Œå¤„ç†
python utils/extract_tar_tokens.py \
    --input_dir /data/audio_tars \
    --output_dir /output/tokens \
    --num_proc 8
```

## æ³¨æ„äº‹é¡¹

1. **å†…å­˜ä½¿ç”¨**: å·¥å…·ä¼šå ç”¨è¾ƒå¤šå†…å­˜ï¼Œå»ºè®®åœ¨å†…å­˜å……è¶³çš„æœºå™¨ä¸Šè¿è¡Œ
2. **GPUèµ„æº**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„GPUå†…å­˜ï¼Œæ¯ä¸ªè¿›ç¨‹ä¼šåŠ è½½å®Œæ•´çš„BiCodecæ¨¡å‹
3. **ç£ç›˜ç©ºé—´**: ç¡®ä¿è¾“å‡ºç›®å½•æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
4. **æ–‡ä»¶æ ¼å¼**: è¾“å…¥æ–‡ä»¶å¿…é¡»æ˜¯taræ ¼å¼ï¼ŒåŒ…å«éŸ³é¢‘å’ŒJSONå…ƒæ•°æ®

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**
   - å‡å°‘`--num_proc`å‚æ•°å€¼
   - ç¡®ä¿GPUå†…å­˜å……è¶³

2. **è¿›ç¨‹åˆå§‹åŒ–å¤±è´¥**
   - æ£€æŸ¥æ¨¡å‹è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§

3. **è¾“å‡ºæ–‡ä»¶ä¸ºç©º**
   - æ£€æŸ¥è¾“å…¥taræ–‡ä»¶æ ¼å¼
   - ç¡®è®¤éŸ³é¢‘æ•°æ®å®Œæ•´æ€§

## è®¸å¯è¯

è¯·å‚è€ƒé¡¹ç›®ä¸»è®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªå·¥å…·ã€‚

---

**ç›¸å…³æ–‡ä»¶**: `utils/extract_tar_tokens.py`
