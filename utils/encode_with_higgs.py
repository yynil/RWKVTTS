from boson_multimodal.audio_processing.higgs_audio_tokenizer import HiggsAudioTokenizer,load_higgs_audio_tokenizer

def load_higgs_tokenizer(model_dir,device):
    tokenizer = load_higgs_audio_tokenizer(model_dir,device)
    return tokenizer



if __name__ == "__main__":
    model_dir = "/home/yueyulin/models/higgs-audio-v2-tokenizer/"
    tokenizer = load_higgs_tokenizer(model_dir,device="cuda:0")
    print(tokenizer)
    import torch
    import torchaudio
    import librosa
    audio_path = "demos/哪吒/nezha_zh.wav"
    
    # 使用 librosa.load() 直接获得 numpy.ndarray
    wav, sample_rate = librosa.load(audio_path, mono=True, sr=None)
    print(f"音频形状: {wav.shape}")
    print(f"采样率: {sample_rate}")
    
    with torch.no_grad():
        vq = tokenizer.encode(wav, sample_rate)
    print(vq)
    print(vq.shape)
    with torch.no_grad():
        wav_recon = tokenizer.decode(vq.unsqueeze(0))[0]
    print(wav_recon.shape)
    torchaudio.save("reconstruct_nezha_zh_higgs.wav", torch.from_numpy(wav_recon), tokenizer.sample_rate)


    vq = torch.tensor(
        [[283, 739, 496, 496, 366, 364, 573, 192, 322, 364, 15, 845, 139, 208, 496, 42, 802, 783, 796, 534, 727, 739, 496, 83, 1003, 673, 413, 711, 540, 413, 134, 502, 496, 484, 484, 802, 837, 131, 415, 61, 340, 458, 500, 376, 889, 484, 340, 685, 434, 573, 59, 573, 978, 458, 496, 698, 496, 1016, 190, 242, 442, 510, 576, 685, 550, 352, 660, 685, 850, 850, 436, 415, 441, 561, 415, 911, 415, 911, 911, 660, 222, 415, 749, 660, 222, 415, 82, 633, 660, 911, 415, 660, 911, 415, 660, 660, 660, 208, 911, 496, 82, 82, 222, 222, 82, 660, 660, 82, 82, 911, 837, 49, 817, 965, 340, 190, 484, 330, 160, 602, 353, 879, 602, 14, 585, 14, 973, 945, 367, 484, 484, 139, 496, 415, 886, 685, 563, 947, 364, 61, 484, 110, 646, 364, 978, 646, 978, 364, 889, 496, 139, 208, 304, 61, 856, 304, 978, 685, 685, 57, 832, 57, 846, 496, 83, 802, 802, 59, 393, 110, 340, 134, 909, 134, 909, 208, 484, 802, 304, 496, 83, 57, 366, 871, 134, 727, 723, 602, 737, 61, 139, 253, 685, 57, 685, 685, 685, 685, 685, 646, 139, 208, 956, 685, 750, 802, 832, 83, 705, 59, 434, 1012, 413, 802, 484, 61, 364, 685, 77, 355, 685, 322, 646, 311, 208, 434, 909, 673, 796, 727, 356, 152, 484, 484, 496, 208, 82, 197, 82, 891, 837, 61, 496, 660, 59, 623, 341, 192, 500, 959, 660, 415, 660, 660, 208, 749, 415], [399, 743, 701, 873, 551, 681, 1004, 641, 743, 630, 206, 368, 807, 887, 181, 103, 662, 192, 702, 963, 42, 743, 877, 204, 129, 528, 376, 226, 81, 220, 497, 503, 479, 913, 216, 331, 101, 331, 551, 164, 179, 367, 1003, 148, 549, 470, 204, 946, 480, 771, 895, 650, 432, 563, 807, 496, 885, 239, 48, 743, 434, 577, 404, 1023, 375, 173, 218, 569, 432, 377, 396, 743, 557, 35, 807, 807, 164, 406, 155, 503, 205, 396, 396, 354, 982, 164, 70, 58, 58, 205, 406, 58, 462, 155, 496, 1021, 858, 621, 496, 79, 406, 557, 396, 999, 832, 496, 496, 377, 877, 919, 462, 299, 772, 617, 999, 772, 470, 167, 661, 818, 880, 670, 685, 368, 291, 88, 322, 1023, 883, 538, 776, 404, 713, 1003, 155, 267, 995, 816, 784, 196, 155, 701, 159, 643, 956, 943, 351, 1007, 679, 998, 807, 1008, 1003, 406, 482, 122, 190, 408, 246, 364, 357, 516, 136, 58, 101, 406, 713, 431, 159, 525, 296, 467, 190, 190, 349, 759, 196, 944, 820, 257, 418, 354, 652, 755, 301, 676, 364, 1002, 431, 828, 212, 730, 483, 288, 113, 355, 113, 188, 818, 939, 549, 429, 404, 30, 167, 953, 528, 204, 497, 478, 108, 108, 551, 917, 828, 828, 375, 672, 957, 226, 702, 208, 932, 465, 857, 368, 630, 782, 86, 128, 981, 602, 404, 198, 710, 347, 299, 807, 832, 802, 807, 212, 957, 583, 53, 897, 998, 54, 40, 468, 444, 406, 944, 944, 434, 567, 917], [506, 268, 998, 816, 3, 502, 572, 273, 404, 224, 321, 99, 341, 109, 998, 768, 869, 475, 317, 887, 112, 124, 475, 960, 783, 327, 59, 1017, 979, 618, 574, 585, 912, 988, 954, 162, 8, 579, 873, 553, 363, 944, 661, 941, 733, 601, 862, 620, 607, 743, 59, 586, 660, 860, 49, 734, 81, 768, 3, 702, 743, 482, 634, 614, 638, 720, 559, 306, 475, 269, 448, 93, 74, 854, 873, 881, 473, 579, 468, 873, 862, 553, 468, 453, 345, 262, 11, 16, 419, 873, 960, 448, 881, 65, 381, 502, 572, 765, 826, 506, 881, 869, 572, 434, 379, 572, 828, 869, 458, 873, 998, 579, 782, 877, 524, 149, 790, 862, 497, 338, 923, 84, 103, 601, 913, 768, 357, 506, 550, 143, 142, 770, 998, 998, 864, 492, 345, 333, 110, 527, 901, 60, 1017, 912, 719, 768, 379, 575, 589, 877, 700, 988, 936, 440, 946, 563, 236, 48, 141, 552, 689, 635, 421, 465, 77, 781, 403, 475, 103, 793, 794, 527, 60, 966, 386, 359, 381, 869, 719, 873, 448, 669, 937, 720, 110, 675, 84, 869, 475, 49, 230, 794, 590, 910, 919, 723, 230, 660, 903, 877, 620, 99, 78, 338, 654, 997, 151, 607, 186, 225, 949, 209, 941, 585, 527, 345, 432, 478, 731, 487, 642, 661, 793, 912, 465, 877, 538, 393, 956, 593, 550, 381, 326, 998, 559, 471, 242, 66, 881, 998, 475, 998, 53, 381, 555, 379, 432, 634, 719, 61, 475, 734, 709, 478, 11, 475, 607], [275, 675, 70, 493, 616, 803, 577, 319, 869, 80, 362, 350, 193, 546, 145, 483, 18, 679, 780, 510, 814, 97, 525, 356, 847, 132, 296, 799, 664, 414, 867, 547, 974, 293, 446, 404, 658, 418, 135, 584, 75, 360, 279, 408, 884, 493, 136, 653, 478, 165, 499, 744, 741, 750, 501, 704, 445, 493, 414, 864, 159, 624, 838, 764, 136, 535, 274, 307, 455, 519, 238, 905, 981, 371, 178, 215, 343, 130, 595, 819, 485, 894, 130, 157, 1009, 343, 974, 841, 467, 546, 310, 157, 865, 75, 351, 974, 547, 934, 360, 804, 248, 275, 841, 372, 467, 961, 819, 548, 187, 935, 852, 187, 384, 134, 484, 173, 251, 208, 233, 922, 484, 259, 437, 824, 41, 729, 640, 869, 208, 897, 90, 376, 433, 687, 149, 465, 21, 130, 96, 356, 272, 763, 940, 740, 138, 203, 997, 703, 825, 958, 592, 371, 403, 96, 606, 476, 975, 137, 293, 80, 69, 187, 216, 96, 130, 676, 679, 211, 169, 807, 256, 150, 853, 214, 312, 124, 735, 921, 307, 202, 636, 666, 635, 171, 179, 98, 668, 273, 853, 493, 968, 683, 546, 407, 870, 424, 559, 854, 359, 541, 1018, 383, 786, 101, 400, 463, 546, 215, 918, 546, 750, 256, 789, 171, 409, 157, 723, 343, 265, 364, 96, 203, 333, 490, 667, 296, 106, 704, 783, 320, 646, 29, 969, 841, 360, 148, 205, 338, 584, 785, 546, 272, 583, 822, 850, 901, 687, 344, 629, 839, 670, 974, 757, 447, 974, 178, 616], [169, 442, 362, 362, 609, 88, 275, 896, 827, 739, 860, 78, 1013, 916, 609, 683, 354, 331, 476, 813, 659, 621, 262, 526, 786, 329, 850, 324, 616, 1010, 436, 108, 538, 324, 2, 105, 799, 270, 709, 989, 984, 209, 41, 582, 526, 122, 177, 141, 325, 123, 475, 609, 43, 762, 622, 939, 799, 931, 620, 318, 278, 967, 631, 196, 5, 181, 731, 791, 1013, 0, 228, 293, 325, 56, 348, 700, 17, 433, 916, 609, 629, 700, 588, 57, 843, 574, 673, 481, 709, 186, 916, 588, 362, 188, 325, 362, 271, 858, 673, 9, 879, 767, 475, 190, 762, 347, 955, 39, 271, 217, 751, 779, 67, 88, 137, 121, 105, 724, 298, 555, 93, 178, 414, 981, 722, 722, 916, 853, 475, 122, 149, 561, 609, 909, 213, 569, 323, 289, 538, 20, 449, 72, 864, 121, 188, 666, 892, 132, 240, 301, 362, 530, 962, 892, 179, 864, 927, 159, 131, 166, 826, 51, 436, 369, 683, 188, 88, 251, 788, 84, 409, 766, 926, 949, 858, 584, 415, 149, 270, 156, 218, 272, 881, 37, 795, 180, 241, 449, 999, 120, 152, 105, 169, 606, 892, 71, 736, 475, 847, 332, 566, 409, 924, 138, 700, 864, 601, 888, 298, 1008, 379, 933, 51, 602, 475, 217, 873, 42, 650, 1022, 713, 128, 56, 517, 598, 771, 771, 584, 780, 508, 133, 532, 118, 190, 513, 864, 122, 474, 122, 916, 325, 324, 661, 571, 217, 127, 790, 280, 907, 864, 224, 686, 604, 688, 108, 564, 513], [475, 507, 554, 263, 376, 870, 652, 838, 205, 281, 167, 769, 109, 714, 500, 574, 12, 967, 257, 318, 545, 708, 69, 75, 1019, 247, 577, 488, 695, 862, 817, 237, 756, 840, 107, 837, 929, 289, 341, 826, 443, 708, 522, 34, 31, 579, 641, 57, 77, 558, 964, 524, 323, 898, 184, 715, 436, 614, 577, 517, 217, 614, 758, 782, 262, 808, 182, 840, 484, 545, 493, 84, 193, 670, 484, 890, 613, 531, 945, 784, 414, 990, 925, 708, 132, 44, 839, 552, 629, 556, 164, 890, 653, 414, 153, 358, 153, 660, 488, 153, 447, 666, 40, 927, 237, 325, 515, 875, 342, 151, 765, 316, 290, 625, 682, 289, 515, 247, 77, 870, 26, 75, 830, 827, 888, 870, 614, 12, 205, 980, 194, 2, 128, 146, 712, 320, 484, 840, 195, 116, 100, 484, 488, 304, 466, 764, 57, 434, 82, 951, 804, 929, 590, 116, 555, 763, 247, 111, 270, 421, 398, 543, 181, 286, 770, 439, 575, 20, 95, 251, 513, 335, 9, 436, 1007, 1, 475, 357, 188, 552, 92, 502, 35, 234, 571, 317, 1007, 67, 179, 25, 781, 431, 846, 846, 614, 681, 36, 106, 834, 588, 203, 1019, 682, 934, 95, 223, 643, 155, 484, 850, 862, 133, 583, 515, 289, 936, 421, 332, 611, 655, 608, 1019, 918, 844, 157, 498, 454, 906, 974, 751, 397, 796, 251, 904, 778, 418, 351, 342, 552, 305, 890, 279, 22, 721, 802, 887, 740, 699, 854, 472, 652, 445, 270, 522, 950, 809, 24], [529, 835, 209, 849, 881, 867, 643, 312, 510, 342, 710, 540, 190, 710, 149, 251, 957, 95, 254, 624, 681, 285, 411, 553, 272, 163, 745, 290, 775, 53, 986, 417, 429, 860, 817, 602, 192, 141, 847, 83, 830, 914, 519, 963, 355, 451, 241, 763, 765, 450, 222, 763, 505, 651, 742, 529, 623, 551, 463, 550, 302, 795, 306, 712, 713, 585, 956, 476, 61, 518, 296, 92, 425, 725, 877, 602, 969, 796, 874, 652, 847, 624, 391, 925, 84, 766, 298, 43, 799, 543, 490, 609, 652, 680, 862, 475, 209, 298, 123, 474, 451, 849, 39, 83, 367, 798, 24, 569, 14, 725, 281, 710, 519, 789, 579, 509, 653, 582, 961, 480, 770, 701, 495, 301, 621, 15, 760, 182, 418, 472, 525, 739, 422, 524, 417, 1009, 556, 442, 219, 839, 4, 25, 461, 529, 206, 210, 21, 373, 302, 163, 200, 50, 564, 302, 538, 874, 705, 973, 413, 358, 254, 944, 39, 620, 693, 426, 163, 780, 633, 550, 325, 688, 430, 760, 581, 102, 639, 945, 415, 305, 296, 291, 299, 738, 426, 849, 302, 324, 242, 761, 359, 681, 1000, 752, 748, 329, 567, 715, 17, 602, 573, 536, 257, 664, 305, 164, 716, 666, 770, 678, 332, 486, 319, 551, 266, 948, 519, 975, 186, 69, 541, 21, 655, 257, 493, 570, 553, 993, 461, 627, 357, 472, 188, 849, 485, 235, 146, 813, 270, 137, 940, 272, 255, 473, 353, 703, 146, 633, 957, 602, 561, 83, 634, 1011, 58, 719, 73], [120, 160, 908, 170, 819, 270, 361, 83, 25, 160, 387, 614, 507, 461, 826, 801, 818, 234, 763, 360, 292, 320, 576, 627, 964, 757, 601, 63, 994, 701, 195, 807, 767, 141, 438, 141, 964, 45, 444, 414, 528, 803, 818, 341, 114, 357, 373, 903, 1023, 246, 102, 938, 378, 975, 834, 964, 22, 619, 191, 273, 938, 902, 973, 583, 573, 885, 225, 707, 453, 390, 310, 666, 310, 528, 215, 581, 229, 367, 688, 419, 787, 338, 419, 438, 6, 372, 82, 1007, 754, 105, 802, 708, 669, 254, 1021, 447, 398, 662, 544, 4, 418, 314, 692, 791, 305, 283, 494, 156, 727, 674, 1023, 215, 114, 130, 129, 322, 188, 781, 81, 475, 495, 18, 492, 300, 346, 811, 1000, 97, 431, 273, 929, 389, 407, 932, 786, 727, 996, 59, 606, 829, 68, 22, 564, 137, 791, 710, 380, 491, 746, 312, 439, 174, 492, 222, 256, 336, 1017, 558, 747, 409, 123, 740, 78, 492, 16, 120, 585, 254, 787, 964, 242, 161, 204, 154, 583, 871, 135, 778, 814, 438, 963, 824, 88, 219, 484, 616, 642, 762, 319, 765, 83, 787, 624, 858, 250, 123, 597, 464, 419, 487, 238, 208, 277, 216, 876, 666, 964, 746, 215, 631, 210, 915, 804, 22, 20, 18, 932, 380, 300, 939, 543, 986, 132, 306, 218, 59, 405, 627, 98, 683, 231, 251, 725, 191, 330, 642, 679, 602, 867, 1022, 486, 1006, 163, 147, 345, 985, 586, 891, 1015, 868, 109, 23, 243, 260, 444, 267, 865]],dtype=torch.int,device="cuda:0"
    )

    with torch.no_grad():
        wav_recon = tokenizer.decode(vq.unsqueeze(0))[0]
    print(wav_recon.shape)
    torchaudio.save("higgs_audio.wav", torch.from_numpy(wav_recon), tokenizer.sample_rate)
